## リポジトリ構成と実装手順（Workers 単一ホスト方式）

このプロジェクトは、1 つの Cloudflare Workers 上で「React の静的配信」「Hono ベースの API」「Durable Objects（DO）」を同居させ、同一オリジンで低レイテンシかつシンプルに運用します。仕様は `docs/全員一致ゲーム.md` に準拠します。

### ディレクトリ構成（案）

```
/src
	/client               # React（Vite, tailwind, GSAP）
		/pages
		/components
		/lib/api.ts
		main.tsx
		index.html
	/server               # Hono + Durable Objects（API と WS）
		index.ts            # Hono エントリ
		/routes
			rooms.ts          # REST/WS エンドポイント
		/do
			RoomDurable.ts    # Durable Object 実装
	/shared               # クライアント/サーバー共通の型
		types.ts            # docs の型を厳密に反映

wrangler.toml           # DO バインディングと静的アセット配信設定
```

### 開発フロー

1. Vite でフロントを開発、Wrangler dev で API/DO を起動
2. 開発中は assets.dev_server で Vite(5173) へリバースプロキシ
3. 本番は `vite build` で `dist/client` を生成し、Workers の assets として配信

### スクリプト（例）

- dev: `wrangler dev`（assets.dev_server で Vite に委譲）
- dev:client: `vite`
- build:client: `vite build`
- deploy: `wrangler deploy`

### ルーティング方針

- 静的: `/` および `/assets/*` は assets から配信
- API: `/api/*` に集約（`docs/全員一致ゲーム.md` のエンドポイントに準拠）
- WS: `/ws/:id` で DO に接続し、現状態の即時送信と以後の更新配信

### 認可

- GM 操作は `gmToken` 必須（ルーム作成時に払い出し、LocalStorage に保持）
- DO 側で `gmId` と `gmToken` の整合を検証

### 永続化

- ルーム内の全状態（ユーザー、設定、進行状況）は DO のメモリ上で管理
- ルーム終了や解散で状態は破棄（ストレージへの put は行わない）

---

## Cloudflare 設定例（wrangler.toml）

```toml
name = "unanimous-game"
main = "src/server/index.ts"
compatibility_date = "2024-06-20"

[assets]
# React Router のビルド成果物を配信（react-router build 後の出力）
directory = "src/client/build/client"
binding = "ASSETS"

[[durable_objects.bindings]]
name = "ROOM_DURABLE"
class_name = "RoomDurable"

[observability]
logs = { enabled = true }
```

補足

- wrangler v4 では `assets.dev_server` は非推奨のため未使用。開発中は `npm run dev:client`（Vite）と `npm run dev`（Workers）を併用し、必要に応じて `npm run build:client` を実行してアセットを更新する。
- Workers 上の SSR は Node 組み込みモジュール（fs/path/stream）を含むため `@react-router/node` が解決できずエラーになります。本プロジェクトは SPA モード（`src/client/react-router.config.ts` の `ssr:false`）で配信し、未マッチは `index.html` にフォールバックする構成に変更しています。

---

## 共有型（`src/shared/types.ts`）

```ts
export type User = {
  id: string;
  name: string;
  icon: string;
  isGM: boolean;
};

export type RoomSettings = {
  topicMode: "gm" | "all";
  winCondition:
    | { type: "count"; value: number }
    | { type: "consecutive"; value: number }
    | { type: "none" };
};

export type Answer = {
  userId: string;
  value: string;
  submittedAt: number;
};

export type Round = {
  id: string;
  topic: string;
  setterId: string;
  answers: Answer[];
  result: "unopened" | "opened";
  unanimous: boolean | null;
};

export type Room = {
  id: string; // 4桁番号
  gmId: string;
  users: User[];
  settings: RoomSettings;
  status: "waiting" | "playing" | "finished";
  rounds: Round[];
};
```

### 実装優先度

**Phase 1: 最小プレイ可能版** ✅ **完了**

1. ✅ ゲーム開始機能
2. ✅ ラウンド作成・お題設定
3. ✅ 回答送信・オープン
4. ✅ 基本的な結果判定

**Phase 2: ゲーム体験の向上** ✅ **完了**

1. ✅ 勝利条件判定
2. ✅ 次のラウンド自動生成
3. ✅ 進行状況表示

**Phase 3: 演出・UX 強化** 🔄 **進行中**

1. 🔄 アニメーション追加
   - ラウンド結果発表時のアニメーション
   - ゲーム終了時の勝利エフェクト
   - 回答状況の視覚的フィードバック
2. ✅ エラー処理強化（基本的なエラーハンドリングは実装済み）
3. ✅ 再接続処理（シンプルな再接続処理は実装済み）
4. ✅ レスポンシブ対応（Expanded コンポーネントによる 800px 幅制限対応済み）

**Phase 4: 新機能・体験向上** 🆕 **新規追加**

1. 🔄 UI/UX 改善
   - ローディング状態の改善
   - 操作フィードバックの強化
   - 参加者の動作状況をリアルタイム表示
2. 📋 コピー機能強化（ルーム番号コピーは実装済み）
3. 🎮 ゲーム体験の向上
   - 特殊アイコン機能の拡張
   - サウンドエフェクト
   - 統計情報の表示
4. 🔧 開発者体験・保守性
   - TypeScript 型安全性の強化
   - テストの追加
   - パフォーマンス最適化

### 開発・テストフロー

1. DO の各エンドポイントを単体でテスト
2. フロントエンドの状態管理ロジックを実装
3. WebSocket イベントの送受信テスト
4. エンドツーエンドの動作確認
5. 複数ブラウザでの同時プレイテスト

## icon はここ

https://iconbu.com/info
